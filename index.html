<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Solar Array Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .panel {
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            border-width: 4px;
        }
        .panel:hover {
            transform: scale(1.08);
            z-index: 10;
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.6);
        }
        
        /* Panel State Colors */
        .panel.full-power { background-color: #3b82f6; } /* blue-500 */
        .panel.throttled { background-color: #f59e0b; } /* amber-500 */

        /* Shaded Effect Overlay */
        .panel.shaded::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(17, 24, 39, 0.85); /* gray-900 85% */
            backdrop-filter: grayscale(90%);
            transition: all 0.2s ease-in-out;
        }
        .panel.shaded-50::before { opacity: 0.5; }
        .panel.shaded-90::before { opacity: 0.9; }

        .panel.shaded::after {
            content: attr(data-shade-level);
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%) rotate(-20deg);
            color: rgba(255, 255, 255, 0.4);
            font-size: 0.7rem;
            font-weight: 800;
            letter-spacing: 1.5px;
            z-index: 1;
        }

        #panel-array {
            display: grid;
            gap: 0.5rem;
            padding: 1rem;
            border-radius: 0.75rem;
            background-color: rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s ease;
        }
        /* String colors for borders - Expanded to 20 colors */
        .string-color-0 { border-color: #ef4444; } .string-color-1 { border-color: #3b82f6; } .string-color-2 { border-color: #22c55e; } .string-color-3 { border-color: #eab308; } .string-color-4 { border-color: #a855f7; } .string-color-5 { border-color: #ec4899; } .string-color-6 { border-color: #14b8a6; } .string-color-7 { border-color: #f97316; } .string-color-8 { border-color: #64748b; } .string-color-9 { border-color: #d946ef; }
        .string-color-10 { border-color: #06b6d4; } .string-color-11 { border-color: #84cc16; } .string-color-12 { border-color: #f43f5e; } .string-color-13 { border-color: #10b981; } .string-color-14 { border-color: #8b5cf6; } .string-color-15 { border-color: #f59e0b; } .string-color-16 { border-color: #6366f1; } .string-color-17 { border-color: #d6d3d1; } .string-color-18 { border-color: #fbbf24; } .string-color-19 { border-color: #4ade80; }
        
        /* Tooltip styles */
        .tooltip {
            position: relative;
            cursor: help;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 240px;
            background-color: #111827; /* gray-900 */
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 10;
            bottom: 125%;
            left: 50%;
            margin-left: -120px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.8rem;
            line-height: 1.4;
            pointer-events: none;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 min-h-screen flex items-center justify-center p-4">
    <main class="w-full max-w-7xl mx-auto bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-4 sm:p-6 lg:p-8">
        <div class="text-center mb-6">
            <h1 class="text-3xl sm:text-4xl font-bold text-blue-600 dark:text-blue-400">Advanced Solar Array Simulator</h1>
            <p class="mt-2 text-gray-600 dark:text-gray-400 max-w-3xl mx-auto">Click panels to cycle through shade levels (0%, 50%, 90%).</p>
        </div>

        <!-- Controls -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-6 p-4 bg-gray-50 dark:bg-gray-700/50 rounded-xl items-start">
            <div>
                <label for="rows" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Rows (<span id="rows-value">4</span>)</label>
                <input type="range" id="rows" min="1" max="10" value="4" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-600" />
            </div>
            <div>
                <label for="cols" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Panels per Row (<span id="cols-value">6</span>)</label>
                <input type="range" id="cols" min="1" max="10" value="6" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-600" />
            </div>
            <div>
                <label for="stringing" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Stringing Strategy</label>
                <select id="stringing" class="w-full mt-1 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="row">By Row</option>
                    <option value="column">By Column</option>
                    <option value="split">Split Array (2 Inverters)</option>
                    <option value="leapfrog">Leapfrog / Zig-zag</option>
                </select>
            </div>
            <div>
                <label for="inverter" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Inverter Type</label>
                <select id="inverter" class="w-full mt-1 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="string">String Inverter</option>
                    <option value="micro">Microinverters</option>
                </select>
            </div>
            <div class="space-y-2">
                 <button id="clear-shade" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md transition-colors">
                    Clear All Shade
                </button>
            </div>
             <!-- New Controls with Tooltips -->
            <div class="col-span-1 md:col-span-2 lg:col-span-3">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Orientation & Tilt</label>
                <div class="grid grid-cols-2 gap-4">
                    <div class="tooltip">
                        <label for="tilt" class="block text-xs font-medium text-gray-500 dark:text-gray-400">Tilt (<span id="tilt-value">15</span>째)</label>
                        <input type="range" id="tilt" min="0" max="90" value="15" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-600" />
                        <span class="tooltiptext">Tilt is the vertical angle of the panels relative to the ground. Optimal for the Philippines is ~15째.</span>
                    </div>
                    <div class="tooltip">
                        <label for="azimuth" class="block text-xs font-medium text-gray-500 dark:text-gray-400">Azimuth (<span id="azimuth-value">180</span>째)</label>
                        <input type="range" id="azimuth" min="90" max="270" value="180" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-600" />
                        <span class="tooltiptext">Azimuth is the compass direction the panels face. 180째 (due South) is optimal for the Northern Hemisphere.</span>
                    </div>
                </div>
            </div>
            <div class="col-span-1 md:col-span-2 lg:col-span-2">
                 <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Pre-set Shade Scenarios</label>
                 <div class="flex space-x-2">
                    <button id="chimney-shade" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-md transition-colors text-xs">Chimney Shadow</button>
                    <button id="morning-shade" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-md transition-colors text-xs">Morning Shade</button>
                 </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2">
                <div id="panel-array"></div>
            </div>
            <div class="lg:col-span-1 bg-gray-50 dark:bg-gray-700/50 p-6 rounded-xl flex flex-col justify-center">
                <h2 class="text-2xl font-bold text-center mb-4">System Performance</h2>
                <div class="space-y-4">
                    <div class="text-center p-3 bg-gray-100 dark:bg-gray-800 rounded-lg">
                        <div id="system-size" class="text-lg font-bold text-blue-600 dark:text-blue-400">-- kW System</div>
                        <div id="panel-count" class="text-xs text-gray-500 dark:text-gray-400">-- Panels</div>
                    </div>
                    <div class="text-center">
                        <div id="total-power" class="text-5xl font-bold text-blue-600 dark:text-blue-400">--</div>
                        <div class="text-sm font-medium text-gray-500 dark:text-gray-400">Current Output (Watts)</div>
                    </div>
                    <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-6 overflow-hidden">
                        <div id="power-bar" class="bg-gradient-to-r from-green-400 to-blue-500 h-6 text-center text-white text-xs font-bold leading-6 transition-all duration-300" style="width: 100%;"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 text-center">
                        <div>
                            <div id="max-power" class="text-2xl font-semibold">--</div>
                            <div class="text-xs text-gray-500 dark:text-gray-400">Max Possible Power</div>
                        </div>
                        <div>
                            <div id="power-loss" class="text-2xl font-semibold text-red-500">--</div>
                            <div class="text-xs text-gray-500 dark:text-gray-400">Power Loss</div>
                        </div>
                    </div>
                    <div class="mt-4 p-4 bg-blue-100 dark:bg-blue-900/40 border-l-4 border-blue-500 rounded-r-lg">
                        <p id="info-text" class="text-sm text-blue-800 dark:text-blue-200"></p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONFIGURATION ---
            const PANEL_MAX_WATTAGE = 550;
            const SHADE_LEVELS = [0, 0.5, 0.9]; // 0%, 50%, 90%

            // --- DOM ELEMENTS ---
            const elements = {
                rowsSlider: document.getElementById('rows'),
                colsSlider: document.getElementById('cols'),
                rowsValue: document.getElementById('rows-value'),
                colsValue: document.getElementById('cols-value'),
                tiltSlider: document.getElementById('tilt'),
                azimuthSlider: document.getElementById('azimuth'),
                tiltValue: document.getElementById('tilt-value'),
                azimuthValue: document.getElementById('azimuth-value'),
                stringingSelect: document.getElementById('stringing'),
                inverterSelect: document.getElementById('inverter'),
                clearShadeBtn: document.getElementById('clear-shade'),
                chimneyShadeBtn: document.getElementById('chimney-shade'),
                morningShadeBtn: document.getElementById('morning-shade'),
                panelArray: document.getElementById('panel-array'),
                systemSize: document.getElementById('system-size'),
                panelCount: document.getElementById('panel-count'),
                totalPower: document.getElementById('total-power'),
                maxPower: document.getElementById('max-power'),
                powerLoss: document.getElementById('power-loss'),
                powerBar: document.getElementById('power-bar'),
                infoText: document.getElementById('info-text'),
            };

            // --- APPLICATION STATE (Single Source of Truth) ---
            let state = {
                rows: 4,
                cols: 6,
                tilt: 15, // Default for Philippines
                azimuth: 180, // Default for Philippines
                stringing: 'row',
                inverter: 'string',
                panels: [], // { id, row, col, shadeLevel, stringId }
            };

            // --- RENDER FUNCTION (The only function that touches the DOM) ---
            function render() {
                // --- 1. Calculate derived state ---
                state.panels.forEach(p => {
                    let stringId = 0;
                    switch (state.stringing) {
                        case 'column': stringId = p.col; break;
                        case 'split': const midRow = Math.floor(state.rows / 2); stringId = p.row < midRow ? p.row : p.row + 10; break;
                        case 'leapfrog': stringId = Math.floor(p.col / 2) + (p.row * Math.ceil(state.cols / 2)); break;
                        default: stringId = p.row; break;
                    }
                    p.stringId = stringId;
                });

                const toRadians = deg => deg * (Math.PI / 180);
                // Optimal tilt for Philippines is ~15 degrees
                const tiltFactor = Math.cos(toRadians(state.tilt - 15));
                const azimuthFactor = Math.cos(toRadians(state.azimuth - 180));
                const deratingFactor = Math.max(0, tiltFactor) * Math.max(0, azimuthFactor);
                const effectiveMaxWattage = PANEL_MAX_WATTAGE * deratingFactor;
                
                const stringShadeMap = new Map();
                let totalPower = 0;

                if (state.inverter === 'string') {
                    state.panels.forEach(p => {
                        const currentMax = stringShadeMap.get(p.stringId) || 0;
                        if (p.shadeLevel > currentMax) stringShadeMap.set(p.stringId, p.shadeLevel);
                    });
                    const strings = {};
                    state.panels.forEach(p => { if (!strings[p.stringId]) strings[p.stringId] = []; strings[p.stringId].push(p); });
                    for (const stringId in strings) {
                        const maxShade = stringShadeMap.get(parseInt(stringId)) || 0;
                        totalPower += strings[stringId].length * (effectiveMaxWattage * (1 - maxShade));
                    }
                } else {
                    state.panels.forEach(p => { totalPower += effectiveMaxWattage * (1 - p.shadeLevel); });
                }

                const maxPower = state.rows * state.cols * effectiveMaxWattage;
                const powerLoss = maxPower - totalPower;
                const powerPercentage = maxPower > 0 ? (totalPower / maxPower) * 100 : 0;

                // --- 2. Update the DOM ---
                elements.panelArray.innerHTML = ''; // Clear previous state
                elements.panelArray.style.gridTemplateColumns = `repeat(${state.cols}, minmax(0, 1fr))`;

                state.panels.forEach(panel => {
                    let visualState = '';
                    if (panel.shadeLevel > 0) {
                        visualState = `shaded shaded-${panel.shadeLevel * 100} full-power`;
                    } else if (state.inverter === 'string' && stringShadeMap.get(panel.stringId) > 0) {
                        visualState = 'throttled';
                    } else {
                        visualState = 'full-power';
                    }
                    const stringColorClass = `string-color-${panel.stringId % 20}`;
                    
                    const panelEl = document.createElement('div');
                    panelEl.className = `panel aspect-square rounded-md ${visualState} ${stringColorClass}`;
                    panelEl.dataset.shadeLevel = panel.shadeLevel > 0 ? `${panel.shadeLevel * 100}%` : '';
                    panelEl.addEventListener('click', () => handlePanelClick(panel.id));
                    elements.panelArray.appendChild(panelEl);
                });
                
                elements.systemSize.textContent = `${(state.rows * state.cols * PANEL_MAX_WATTAGE / 1000).toFixed(2)} kW System`;
                elements.panelCount.textContent = `${state.rows * state.cols} Panels`;
                elements.totalPower.textContent = Math.round(totalPower);
                elements.maxPower.textContent = Math.round(maxPower).toLocaleString();
                elements.powerLoss.textContent = Math.round(powerLoss).toLocaleString();
                elements.powerBar.style.width = `${powerPercentage}%`;
                elements.powerBar.textContent = `${Math.round(powerPercentage)}%`;
                elements.infoText.innerHTML = state.inverter === 'string'
                    ? `<strong>String Inverter:</strong> A string's output is limited by its most shaded panel. All panels in a shaded string (yellow) drop to the same reduced output.`
                    : `<strong>Microinverters:</strong> Each panel operates independently. Shading only affects the specific panel that is clicked.`;
            }

            // --- EVENT HANDLERS (Only modify state, then call render) ---
            function handleControlChange(event) {
                const { id, value } = event.target;
                state[id] = value;
                if (['rows', 'cols', 'tilt', 'azimuth'].includes(id)) {
                    elements[id + 'Value'].textContent = value;
                }
                
                if (['rows', 'cols'].includes(id)) {
                    // Rebuild the panel data array when dimensions change
                    const oldShadeMap = new Map(state.panels.map(p => [`${p.row}-${p.col}`, p.shadeLevel]));
                    state.panels = [];
                    let panelId = 0;
                    for (let r = 0; r < state.rows; r++) {
                        for (let c = 0; c < state.cols; c++) {
                            state.panels.push({ id: panelId++, row: r, col: c, shadeLevel: oldShadeMap.get(`${r}-${c}`) || 0, stringId: 0 });
                        }
                    }
                }
                render();
            }

            function handlePanelClick(panelId) {
                const panel = state.panels.find(p => p.id === panelId);
                if (panel) {
                    const currentIndex = SHADE_LEVELS.indexOf(panel.shadeLevel);
                    panel.shadeLevel = SHADE_LEVELS[(currentIndex + 1) % SHADE_LEVELS.length];
                    render();
                }
            }
            
            function handleClearShade() {
                state.panels.forEach(p => p.shadeLevel = 0);
                render();
            }

            function applyChimneyShade() {
                handleClearShade();
                const chimneyCol = Math.floor(state.cols / 2);
                state.panels.forEach(p => {
                    if (p.col === chimneyCol) p.shadeLevel = 0.9;
                    if (p.col === chimneyCol - 1) p.shadeLevel = 0.5;
                });
                render();
            }

            function applyMorningShade() {
                handleClearShade();
                state.panels.forEach(p => {
                    if (p.col === 0) p.shadeLevel = 0.9;
                    if (p.col === 1) p.shadeLevel = 0.5;
                });
                render();
            }

            // --- INITIALIZATION ---
            function init() {
                // Set initial state from controls' default values
                Object.keys(state).forEach(key => {
                    const el = elements[key + 'Slider'] || elements[key + 'Select'];
                    if (el) state[key] = el.value;
                });

                ['rowsSlider', 'colsSlider', 'tiltSlider', 'azimuthSlider', 'stringingSelect', 'inverterSelect'].forEach(id => {
                    elements[id].addEventListener('input', handleControlChange);
                });
                
                elements.clearShadeBtn.addEventListener('click', handleClearShade);
                elements.chimneyShadeBtn.addEventListener('click', applyChimneyShade);
                elements.morningShadeBtn.addEventListener('click', applyMorningShade);

                // Build initial panel data before first render
                let panelId = 0;
                for (let r = 0; r < state.rows; r++) {
                    for (let c = 0; c < state.cols; c++) {
                        state.panels.push({ id: panelId++, row: r, col: c, shadeLevel: 0, stringId: 0 });
                    }
                }
                render();
            }

            init();
        });
    </script>
</body>
</html>
